<link rel="import" href="../../bower_components/polymer/polymer-element.html">
<link rel="import" href="../../bower_components/polymerfire/firebase-query.html">
<link rel="import" href="../../bower_components/paper-card/paper-card.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../bower_components/paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="../../bower_components/paper-listbox/paper-listbox.html">
<link rel="import" href="../../bower_components/paper-item/paper-item.html">
<link rel="import" href="../../bower_components/polymerfire/firebase-document.html">


<dom-module id="create-room">

  <template>

    <style>
      .create-room {
        padding: 5px 75px 25px 75px;
        text-align: center;
      }
    </style>

    <paper-card class="create-room">
      <h3>Create Room</h3>
      <div>
          <paper-input id="roomName" placeholder="Room name" type="text"></paper-input>
          <paper-button on-click="createRoom">Create</paper-button>
      </div>
  
      <div>
          <paper-dropdown-menu id="roomSelection" label="Previous Rooms">
            <paper-listbox slot="dropdown-content" selected="">
              <template is="dom-repeat" items="[[roomDataArray]]">
                  <paper-item value="[[item.name]]">[[item.value.name]]</paper-item>
              </template>
            </paper-listbox>
          </paper-dropdown-menu>
          <paper-button on-click="copyRoom">Copy from Previous</paper-button>
      </div>
    </paper-card>

    <firebase-document path="/rooms" data="{{roomData}}"/>
    <firebase-query id="createRoomQuery" path="/rooms"></firebase-query>

  </template>

  <script>
    class CreateRoom extends Polymer.Element {
      static get is() { return 'create-room'; }

      static get properties() {
        return {

          'roomData': {
            type: Object,
            observer: '_roomDataChange'
          },
          'roomDataArray' :{
            type:Array
          }
        };
      }

      _toArray(obj) {
            return Object.keys(obj).map(function(key) {
                return {
                    name: key,
                    value: obj[key]
                };
            });
        }

      _roomDataChange(newValue, oldValue) {
        this.roomDataArray = this._toArray(newValue);
        console.log(newValue, oldValue);
      }

      createRoom() {
        this.$.createRoomQuery.ref
          .push({name: this.$.roomName.value})
          .then(this.dispatchJoinRoomEvent);
      }

      copyRoom(){
        var oldTries = this.roomData[this.$.roomSelection.value.value].tries;
        this.$.createRoomQuery.ref
          .push({name: this.$.roomName.value, tries: oldTries})
          .then(this.dispatchJoinRoomEvent);
      }

      dispatchJoinRoomEvent(room) {
        document.dispatchEvent(new CustomEvent('on-join-room', {detail: {roomKey: room.key}}));
      }

    }

    window.customElements.define(CreateRoom.is, CreateRoom);
  </script>
</dom-module>